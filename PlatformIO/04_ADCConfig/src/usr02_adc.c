/*
# ##############################################################################
# File: usr02_adc.c                                                            #
# Project: src                                                                 #
# Created Date: Saturday, September 30th 2023, 8:01:17 pm                      #
# Author: Zafeer Abbasi                                                        #
# ----------------------------------------------                               #
# Last Modified: Sunday, October 1st 2023, 7:56:02 pm                          #
# Modified By: Zafeer Abbasi                                                   #
# ----------------------------------------------                               #
# Copyright (c) 2023 Zafeer.A                                                  #
# ----------------------------------------------                               #
# HISTORY:                                                                     #
 */

/*##############################################################################################################################################*/
/*INCLUDES______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

#include "usr02_adc.h"

/*##############################################################################################################################################*/
/*FUNCTION DECLARATIONS_________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*GLOBALS_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

/*ADC Handle Typedef*/
ADC_HandleTypeDef hADC1;

/*##############################################################################################################################################*/
/*DEFINES_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*TYPEDEFS/STRUCTS/ENUMS________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/



/*##############################################################################################################################################*/
/*FUNCTIONS_____________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/

/**
 * @brief ADC Config for ADC12 INP3; ADC1/2 Channel 3 Input Positive Single Ended
 * 
 */
void ADC_ADC12INP3PA6Init( void )
{
    /*Enable Clocks*/
    __HAL_RCC_ADC12_CLK_ENABLE( );
    __HAL_RCC_GPIOA_CLK_ENABLE( );

    /*GPIO Pin Configuration; PA6 ADC12_INP3 */
    GPIO_InitTypeDef GPIO_initStruct = { 0 };
    GPIO_initStruct.Pin     = GPIO_PIN_6;
    GPIO_initStruct.Mode    = GPIO_MODE_ANALOG;
    GPIO_initStruct.Pull    = GPIO_NOPULL;
    HAL_GPIO_Init( ADC1_SENSOR_PORT, &GPIO_initStruct );

    /*ADC Configuration: ADC1*/
    hADC1.Instance = ADC1;
    hADC1.Init.ClockPrescaler   = ADC_CLOCK_ASYNC_DIV1;
    hADC1.Init.Resolution       = ADC_RESOLUTION_12B;
    hADC1.Init.ExternalTrigConv = ADC_SOFTWARE_START;
    hADC1.Init.NbrOfConversion  = 1;
    hADC1.Init.EOCSelection     = ADC_EOC_SINGLE_CONV;
    
    if( HAL_ADC_Init( &hADC1 ) != HAL_OK )
    {
        ERROR_errorHandler( );
    }

    /*ADC Channel Config*/
    ADC_ChannelConfTypeDef sConfig = { 0 };
    sConfig.Channel     = ADC_CHANNEL_3;
    sConfig.Rank        = ADC_REGULAR_RANK_1;
    sConfig.SamplingTime= ADC_SAMPLETIME_810CYCLES_5;
    sConfig.SingleDiff  = ADC_SINGLE_ENDED;
    
    if( HAL_ADC_ConfigChannel( &hADC1, &sConfig ) != HAL_OK )
    {
        ERROR_errorHandler( );
    }

    /*Calibration*/
    HAL_ADCEx_Calibration_Start( &hADC1, ADC_CALIB_OFFSET, ADC_SINGLE_ENDED );
}

/**
 * @brief Convert ADC Reading to Voltage
 * 
 * @param ADCValue ADC Reading, 0 - 4096 
 * @return float Voltage
 */
float ADC_ADCToVoltage( int ADCValue )
{
    float maxADCValue = 4095.0;
    return ( ADCValue / maxADCValue ) * 3.3;
}

/*##############################################################################################################################################*/
/*EXTERNS_______________________________________________________________________________________________________________________________________*/
/*##############################################################################################################################################*/